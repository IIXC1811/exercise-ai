<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">

<!-- üî• ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<title>Exercise AI</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>

body{
    background:black;
    color:white;
    text-align:center;
    font-family:Arial;
    margin:0;
}

/* üî• ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏ß‡∏¢ */
video, canvas{
    width:95%;
    max-width:700px;
    border-radius:20px;
}

/* üî• ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏¢‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
.buttons{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
}

button{
    padding:12px;
    margin:6px;
    border-radius:12px;
    border:none;
    font-size:16px;
    font-weight:bold;
}

h1{
    margin-top:10px;
}

</style>
</head>

<body>

<h1>Exercise AI</h1>

<video class="input_video" autoplay playsinline></video>
<canvas class="output_canvas"></canvas>

<br>

<div class="buttons">
<button onclick="setMode('PUSHUP')">Push-up</button>
<button onclick="setMode('SQUAT')">Squat</button>
<button onclick="setMode('PLANK')">Plank</button>
<button onclick="setMode('SITUP')">Sit-up</button>
<button onclick="setMode('LATERAL')">Side Lateral</button>
<button onclick="setMode('NONE')">None</button>
</div>

<h2 id="modeText">MODE: NONE</h2>
<h2 id="reps">REPS: 0</h2>

<script>

// üî• register ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î (‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ)
window.addEventListener("load", () => {
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
    }
});

let currentMode = "NONE";
let counter = 0;
let stage = null;

function setMode(mode){
    currentMode = mode;
    counter = 0;
    stage = null;

    modeText.innerText = "MODE: " + mode;
    reps.innerText = "REPS: 0";
}

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°
function calculateAngle(a,b,c){

    let radians =
        Math.atan2(c.y-b.y, c.x-b.x) -
        Math.atan2(a.y-b.y, a.x-b.x);

    let angle = Math.abs(radians * 180.0 / Math.PI);

    if(angle > 180){
        angle = 360 - angle;
    }

    return angle;
}

const video = document.querySelector('.input_video');
const canvas = document.querySelector('.output_canvas');
const canvasCtx = canvas.getContext('2d');

const pose = new Pose({
    locateFile: (file)=>{
        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }
});

pose.setOptions({
    modelComplexity:1,
    smoothLandmarks:false,
    minDetectionConfidence:0.6,
    minTrackingConfidence:0.6
});

pose.onResults(onResults);

function onResults(results){

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    canvasCtx.clearRect(0,0,canvas.width,canvas.height);
    canvasCtx.drawImage(results.image,0,0,canvas.width,canvas.height);

    if(results.poseLandmarks){

        drawConnectors(canvasCtx,results.poseLandmarks,
            POSE_CONNECTIONS,{color:'lime', lineWidth:4});

        drawLandmarks(canvasCtx,results.poseLandmarks,
            {color:'red', lineWidth:2});

        const lm = results.poseLandmarks;

        const shoulder = lm[11];
        const elbow = lm[13];
        const wrist = lm[15];
        const hip = lm[23];
        const knee = lm[25];
        const ankle = lm[27];

        // üî• SQUAT
        if(currentMode==="SQUAT"){

            let kneeAngle = calculateAngle(hip,knee,ankle);

            if(kneeAngle>165) stage="UP";

            if(kneeAngle<95 && stage==="UP"){
                stage="DOWN";
                counter++;
                reps.innerText="REPS: "+counter;
            }
        }

        // üî• PUSHUP
        if(currentMode==="PUSHUP"){

            let elbowAngle = calculateAngle(shoulder,elbow,wrist);

            if(elbowAngle>160) stage="UP";

            if(elbowAngle<90 && stage==="UP"){
                stage="DOWN";
                counter++;
                reps.innerText="REPS: "+counter;
            }
        }

        // üî• SITUP
        if(currentMode==="SITUP"){

            let sitAngle = calculateAngle(shoulder,hip,knee);

            if(sitAngle>150) stage="DOWN";

            if(sitAngle<90 && stage==="DOWN"){
                stage="UP";
                counter++;
                reps.innerText="REPS: "+counter;
            }
        }

        // üî• LATERAL
        if(currentMode==="LATERAL"){

            let armAngle = calculateAngle(hip,shoulder,elbow);

            if(armAngle<30) stage="DOWN";

            if(armAngle>80 && armAngle<120 && stage==="DOWN"){
                stage="UP";
                counter++;
                reps.innerText="REPS: "+counter;
            }
        }

        // üî• PLANK (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ ‚Äî ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ logic)
        if(currentMode==="PLANK"){

            let bodyAngle = calculateAngle(shoulder,hip,ankle);

            modeText.innerText =
                bodyAngle > 160
                ? "PLANK ‚úÖ GOOD"
                : "PLANK ‚ùå STRAIGHTEN BODY";
        }

    }
}

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
const camera = new Camera(video,{
    onFrame: async ()=>{
        await pose.send({image:video});
    },
    width:640,
    height:480
});

camera.start();

</script>

</body>
</html>
